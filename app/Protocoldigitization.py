from docxtpl import DocxTemplate
from azure.storage.blob import BlobServiceClient
import os

# -------------------------
# CONFIG
# -------------------------
AZURE_CONN_STR = os.getenv("AZURE_STORAGE_CONNECTION_STRING")
CONTAINER_NAME = os.getenv("BLOB_CONTAINER_NAME")
RAW_FOLDER = "raw"


def upload_to_blob(local_file_path: str, blob_path: str):
    """
    Uploads a file to Azure Blob Storage
    """
    blob_service_client = BlobServiceClient.from_connection_string(AZURE_CONN_STR)
    container_client = blob_service_client.get_container_client(CONTAINER_NAME)

    blob_client = container_client.get_blob_client(blob_path)

    with open(local_file_path, "rb") as file:
        blob_client.upload_blob(file, overwrite=True)

    print(f"☁️ Uploaded to Blob Storage → {blob_path}")


def render_docx(message: str):
    """
    Renders DOCX from template and uploads it to Blob Storage (raw/)
    """
    doc = DocxTemplate("CSR.docx")

    context = {
        "inclusion_criterion": message
    }

    doc.render(context)

    output_file = "filled_document.docx"
    doc.save(output_file)
    print(f"✅ DOCX rendered → {output_file}")

    # Upload to blob: raw/filled_document.docx
    blob_path = f"{RAW_FOLDER}/{output_file}"
    upload_to_blob(output_file, blob_path)


if __name__ == "__main__":
    render_docx("This inclusion criterion text was generated by the LLM.")
