import os, sys
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

import re
from docxtpl import RichText

from io import BytesIO
from docxtpl import DocxTemplate, RichText
from azure.storage.blob import BlobServiceClient

from config.settings import (
    AZURE_BLOB_CONN_STRING,
    BLOB_CONTAINER,
    INDEX_PREFIX,
)

TEMPLATE_NAME = "CSR.docx"
OUTPUT_NAME = "CSR_filled.docx"




# --------------------------------------------------
# SECTION ‚Üí TEMPLATE VARIABLE MAPPING
# --------------------------------------------------
SECTION_TO_TEMPLATE_VAR = {
    "Inclusion Criteria": "inclusion_criteria",
    "Clinical Trial Synopsis": "exclusion_criteria ",
    # add more sections here as you scale
}


def normalize_prefix(prefix: str) -> str:
    """
    Ensures no trailing slash
    """
    return prefix.rstrip("/")


def build_context_from_section(
    llm_text: str | RichText,
    section_name: str
) -> dict:
    """
    Converts an LLM answer + section name into a docxtpl context dict.
    """

    if section_name not in SECTION_TO_TEMPLATE_VAR:
        raise ValueError(
            f"No template mapping found for section: {section_name}"
        )

    template_key = SECTION_TO_TEMPLATE_VAR[section_name]

    # Ensure RichText
    if isinstance(llm_text, RichText):
        rich_text = llm_text
    else:
        rich_text = RichText(llm_text)

    return {
        template_key: rich_text
    }



def render_docx(llm_text: str | RichText, section_name: str):
    prefix = normalize_prefix(INDEX_PREFIX)

    blob_service = BlobServiceClient.from_connection_string(
        AZURE_BLOB_CONN_STRING
    )
    container = blob_service.get_container_client(BLOB_CONTAINER)

    template_blob_path = f"{prefix}/{TEMPLATE_NAME}"
    print("Downloading template:", template_blob_path)

    template_blob = container.get_blob_client(template_blob_path)

    if not template_blob.exists():
        raise FileNotFoundError(
            f"Template not found in blob storage: {template_blob_path}"
        )

    template_bytes = template_blob.download_blob().readall()
    template_stream = BytesIO(template_bytes)

    doc = DocxTemplate(template_stream)

    # üîë Dynamic context
    context = build_context_from_section(
        llm_text=llm_text,
        section_name=section_name
    )

    doc.render(context)

    output_stream = BytesIO()
    doc.save(output_stream)
    output_stream.seek(0)

    output_blob_path = f"{prefix}/{OUTPUT_NAME}"
    print("Uploading rendered file:", output_blob_path)

    output_blob = container.get_blob_client(output_blob_path)
    output_blob.upload_blob(output_stream, overwrite=True)

    print(f"‚òÅÔ∏è CSR rendered & uploaded ‚Üí {output_blob_path}")

# -------------------------
# ENTRY
# -------------------------
if __name__ == "__main__":
    render_docx(
        RichText("This inclusion criterion was generated by the **LLM and injected into CRS<10.**")
    )